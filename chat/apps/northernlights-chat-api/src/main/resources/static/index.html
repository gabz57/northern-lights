<!DOCTYPE html>
<html>
<head>
    <title>Server Memory Monitor</title>
    <script src="eventsource.js" type="text/javascript"></script>
    <script>
        async function authent(userId) {
            const myHeaders = new Headers();
            myHeaders.append("Authorization", 'Bearer ' + userId);
            myHeaders.append("Accept", "application/json");
            myHeaders.append("Content-Type", "application/json");
            const response = await fetch("http://localhost:8080/v1/chat/api/auth", {
                method: 'POST',
                body: JSON.stringify({
                    'conversationStatuses': {}
                }), // string or object
                headers: myHeaders
            });

            return (await response.json()).sseChatKey;
        }

        async function initialize() {

            const sseChatKey = await authent("1")

            const eventSource = new EventSourcePolyfill("http://localhost:8080/v1/chat/api/sse", {
                headers: {
                    "sse-chat-key": sseChatKey
                }
            });

            eventSource.onopen = e => console.log('open');

            eventSource.onerror = e => {
                console.log('eventSource.onerror');
                if (e.readyState == EventSource.CLOSED) {
                    console.log('close');
                } else {
                    console.log(e);
                }
            };

            eventSource.onmessage = e => console.log('message', JSON.parse(e.data));

            eventSource.addEventListener('CHATTER:INSTALL', function (e) {
                console.log('CHATTER:INSTALL', e.data);
                const newElement = document.createElement("li");
                const eventList = document.getElementById("chatters");
                newElement.textContent = e.data;
                eventList.appendChild(newElement);
            }, false);

            eventSource.addEventListener('CONVERS:INSTALL', function (e) {
                console.log('CONVERS:INSTALL', e.data);
                const newElement = document.createElement("li");
                const eventList = document.getElementById("conversations");
                newElement.textContent = e.data;
                eventList.appendChild(newElement);
            }, false);

            eventSource.addEventListener('CONVERS:UPDATE:MESSAGE', function (e) {
                console.log('CONVERS:UPDATE:MESSAGE', e.data);
                const newElement = document.createElement("li");
                const eventList = document.getElementById("messages");
                newElement.textContent = e.data;
                eventList.appendChild(newElement);
            }, false);

            // eventSource.addEventListener('memory', function (e) {
            //     console.log('memory', e.data);
            //     const msg = JSON.parse(e.data);
            //     document.getElementById("timestamp").innerHTML = new Date(msg.ts);
            //     document.getElementById("heap").innerHTML = msg.heap;
            //     document.getElementById("nonheap").innerHTML = msg.nonHeap;
            // }, false);
        }

        window.onload = initialize;
    </script>
</head>
<body>
<h1>Sse Chat</h1>

<h3>Chatters</h3>
<div>
    <ul id="chatters"></ul>
</div>

<h3>Conversations</h3>
<div>
    <ul id="conversations"></ul>
</div>

<h3>Messages</h3>
<div>
    <ul id="messages"></ul>
</div>
</body>
</html>
